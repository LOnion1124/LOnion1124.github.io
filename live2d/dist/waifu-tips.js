/*!
 * Live2D Widget
 * https://github.com/stevenjoezhang/live2d-widget
 */
function e(e){return Array.isArray(e)?e[Math.floor(Math.random()*e.length)]:e}let t=null;function i(i,s,o,a=!0){let n=parseInt(sessionStorage.getItem("waifu-message-priority"),10);if(isNaN(n)&&(n=0),!i||a&&n>o||!a&&n>=o)return;t&&(clearTimeout(t),t=null),i=e(i),sessionStorage.setItem("waifu-message-priority",String(o));const l=document.getElementById("waifu-tips");l.innerHTML=i,l.classList.add("waifu-tips-active"),t=setTimeout(()=>{sessionStorage.removeItem("waifu-message-priority"),l.classList.remove("waifu-tips-active")},s)}function s(e,...t){return e.replace(/\$(\d+)/g,(e,i)=>{var s;const o=parseInt(i,10)-1;return null!==(s=t[o])&&void 0!==s?s:""})}class o{constructor(e="info"){this.level=e}setLevel(e){e&&(this.level=e)}shouldLog(e){return o.levelOrder[e]<=o.levelOrder[this.level]}error(e,...t){this.shouldLog("error")&&console.error("[Live2D Widget][ERROR]",e,...t)}warn(e,...t){this.shouldLog("warn")&&console.warn("[Live2D Widget][WARN]",e,...t)}info(e,...t){this.shouldLog("info")&&console.log("[Live2D Widget][INFO]",e,...t)}trace(e,...t){this.shouldLog("trace")&&console.log("[Live2D Widget][TRACE]",e,...t)}}o.levelOrder={error:0,warn:1,info:2,trace:3};const a=new o;class n{constructor(e,t=[]){var i;this.modelList=null;let{apiPath:s,cdnPath:o}=e;const{cubism2Path:n,cubism5Path:l}=e;let d=!1;if("string"==typeof o)o.endsWith("/")||(o+="/"),d=!0;else if("string"==typeof s)s.endsWith("/")||(s+="/"),o=s,d=!0,a.warn("apiPath option is deprecated. Please use cdnPath instead.");else if(!t.length)throw"Invalid initWidget argument!";let r=parseInt(localStorage.getItem("modelId"),10),c=parseInt(localStorage.getItem("modelTexturesId"),10);(isNaN(r)||isNaN(c))&&(c=0),isNaN(r)&&(r=null!==(i=e.modelId)&&void 0!==i?i:0),this.useCDN=d,this.cdnPath=o||"",this.cubism2Path=n||"",this.cubism5Path=l||"",this._modelId=r,this._modelTexturesId=c,this.currentModelVersion=0,this.loading=!1,this.modelJSONCache={},this.models=t}static async initCheck(e,t=[]){const i=new n(e,t);return i.useCDN||(i.modelId>=i.models.length&&(i.modelId=0),i.modelTexturesId>=i.models[i.modelId].paths.length&&(i.modelTexturesId=0)),i}set modelId(e){this._modelId=e,localStorage.setItem("modelId",e.toString())}get modelId(){return this._modelId}set modelTexturesId(e){this._modelTexturesId=e,localStorage.setItem("modelTexturesId",e.toString())}get modelTexturesId(){return this._modelTexturesId}resetCanvas(){document.getElementById("waifu-canvas").innerHTML='<canvas id="live2d" width="800" height="800"></canvas>'}async fetchWithCache(e){let t;if(e in this.modelJSONCache)t=this.modelJSONCache[e];else{try{const i=await fetch(e);t=await i.json()}catch(e){t=null}this.modelJSONCache[e]=t}return t}checkModelVersion(e){return 3===e.Version||e.FileReferences?3:2}async loadLive2D(e,t){if(this.loading)a.warn("Still loading. Abort.");else{this.loading=!0;try{const s=this.checkModelVersion(t);if(2===s){if(!this.cubism2model){if(!this.cubism2Path)return void a.error("No cubism2Path set, cannot load Cubism 2 Core.");await(i=this.cubism2Path,new Promise((e,t)=>{let s;s=document.createElement("script"),s.src=i,s&&(s.onload=()=>e(i),s.onerror=()=>t(i),document.head.appendChild(s))}));const{default:e}=await import("./chunk/index.js");this.cubism2model=new e}3===this.currentModelVersion&&(this.cubism5model.release(),this.resetCanvas()),3!==this.currentModelVersion&&this.cubism2model.gl?await this.cubism2model.changeModelWithJSON(e,t):await this.cubism2model.init("live2d",e,t)}a.info(`Model ${e} (Cubism version ${s}) loaded`),this.currentModelVersion=s}catch(e){console.error("loadLive2D failed",e)}var i;this.loading=!1}}async loadTextureCache(e){return await this.fetchWithCache(`${this.cdnPath}model/${e}/textures.cache`)||[]}async loadModel(e){let t,s;this.useCDN||(t=this.models[this.modelId].paths[this.modelTexturesId],s=await this.fetchWithCache(t)),await this.loadLive2D(t,s),i(e,4e3,10)}async loadRandTexture(e="",t=""){const{modelId:s}=this;let o=!1;this.useCDN||(1===this.models[s].paths.length?o=!0:this.modelTexturesId=function(e,t){const i=Math.floor(Math.random()*(e-1));return i>=t?i+1:i}(this.models[s].paths.length,this.modelTexturesId)),o?i(t,4e3,10):await this.loadModel(e)}async loadNextModel(){this.modelTexturesId=0,this.useCDN?(this.modelId=(this.modelId+1)%this.modelList.models.length,await this.loadModel(this.modelList.messages[this.modelId])):(this.modelId=(this.modelId+1)%this.models.length,await this.loadModel(this.models[this.modelId].message))}}async function l(t){var o;sessionStorage.removeItem("waifu-message-priority");let a,l=[];if(t.waifuPath){const o=await fetch(t.waifuPath);a=await o.json(),l=a.models,function(t){let s,o=!1;const a=t.message.default;let n;t.seasons.forEach(({date:t,text:i})=>{const s=new Date,o=t.split("-")[0],n=t.split("-")[1]||o;Number(o.split("/")[0])<=s.getMonth()+1&&s.getMonth()+1<=Number(n.split("/")[0])&&Number(o.split("/")[1])<=s.getDate()&&s.getDate()<=Number(n.split("/")[1])&&(i=(i=e(i)).replace("{year}",String(s.getFullYear())),a.push(i))}),window.addEventListener("mousemove",()=>o=!0),window.addEventListener("keydown",()=>o=!0),setInterval(()=>{o?(o=!1,clearInterval(s),s=null):s||(s=setInterval(()=>{i(a,6e3,9)},2e4))},1e3),window.addEventListener("mouseover",s=>{var o;for(let{selector:a,text:l}of t.mouseover)if(null===(o=s.target)||void 0===o?void 0:o.closest(a)){if(n===a)return;return n=a,l=e(l),l=l.replace("{text}",s.target.innerText),void i(l,4e3,8)}}),window.addEventListener("click",s=>{var o;for(let{selector:a,text:n}of t.click)if(null===(o=s.target)||void 0===o?void 0:o.closest(a))return n=e(n),n=n.replace("{text}",s.target.innerText),void i(n,4e3,8)}),window.addEventListener("live2d:hoverbody",()=>{i(e(t.message.hoverBody),4e3,8,!1)}),window.addEventListener("live2d:tapbody",()=>{i(e(t.message.tapBody),4e3,9)});const l=()=>{};console.log("%c",l),l.toString=()=>{i(t.message.console,6e3,9)},window.addEventListener("copy",()=>{i(t.message.copy,6e3,9)}),window.addEventListener("visibilitychange",()=>{document.hidden||i(t.message.visibilitychange,6e3,9)})}(a),i(function(e,t,i){if("/"===location.pathname)for(const{hour:t,text:i}of e){const e=new Date,s=t.split("-")[0],o=t.split("-")[1]||s;if(Number(s)<=e.getHours()&&e.getHours()<=Number(o))return i}if(!t)return"";const o=s(t,document.title);if(""===document.referrer||!i)return o;const a=new URL(document.referrer);return location.hostname===a.hostname?o:`${s(i,a.hostname)}<br>${o}`}(a.time,a.message.welcome,a.message.referrer),7e3,11)}const d=await n.initCheck(t,l);await d.loadModel(""),null===(o=document.getElementById("waifu"))||void 0===o||o.classList.add("waifu-active")}window.initWidget=function(e){if("string"==typeof e)return void a.error("Your config for Live2D initWidget is outdated. Please refer to https://github.com/stevenjoezhang/live2d-widget/blob/master/dist/autoload.js");a.setLevel(e.logLevel);const t=document.getElementById("waifu-toggle");t||a.warn("No #waifu-toggle element found. Add a fixed button in your HTML to toggle the widget."),null==t||t.addEventListener("click",async()=>{const t=document.getElementById("waifu");if(!t)return;if(t.classList.contains("waifu-active")&&!t.classList.contains("waifu-hidden")){if(e.waifuPath)try{const t=await fetch(e.waifuPath);i((await t.json()).message.goodbye,2e3,11)}catch(e){}t.classList.remove("waifu-active"),t.classList.add("waifu-hidden")}else t.classList.remove("waifu-hidden"),setTimeout(()=>{t.classList.add("waifu-active")},0)}),console.log("loading widget"),l(e)};export{a as l};
//# sourceMappingURL=waifu-tips.js.map
